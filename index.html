<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<title>Ekkorn è©±è¡“å·¥å…· 2.3</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
:root {
  --primary: #ff7a1a;
  --primary-soft: #ffe0c7;
  --bg: #f5f7fb;
  --card-bg: #ffffff;
  --border-radius: 16px;
}

* { box-sizing: border-box; }

body {
  font-family: "Noto Sans TC", system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
  background: radial-gradient(circle at top left, #ffe8d2, #f5f7fb 40%);
  margin: 0;
  padding: 28px;
  color: #333;
  font-size: 15px;
}

.app {
  max-width: 1320px;
  margin: 0 auto;
  background: rgba(255,255,255,0.94);
  border-radius: 24px;
  box-shadow: 0 18px 52px rgba(0,0,0,0.1);
  padding: 26px;
  backdrop-filter: blur(10px);
}

header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  gap: 10px;
  flex-wrap: wrap;
  margin-bottom: 12px;
}

.title-block h1 {
  margin: 0;
  font-size: 26px;
}

.title-block p {
  margin: 4px 0 0;
  font-size: 14px;
  color: #777;
}

#globalSearch {
  width: 100%;
  padding: 10px 14px;
  border-radius: 999px;
  border: 1px solid #e0e2ea;
  font-size: 14px;
  margin: 10px 0 6px;
  outline: none;
}
#globalSearch:focus {
  border-color: var(--primary);
  box-shadow: 0 0 0 2px rgba(255,122,26,0.15);
}

/* å¿«é€Ÿæœå°‹åˆ— */
.quick-container {
  display: flex;
  flex-wrap: wrap;
  gap: 6px;
  align-items: center;
  margin-bottom: 12px;
}

.quick-label {
  font-size: 12px;
  color: #777;
  margin-right: 4px;
}

.quick-chip {
  border: none;
  border-radius: 999px;
  padding: 4px 10px;
  font-size: 12px;
  background: #f2f3f7;
  color: #555;
  cursor: pointer;
}
.quick-chip:hover {
  background: #ffe0c7;
  color: #b25a12;
}

.quick-edit-btn {
  border: none;
  background: transparent;
  font-size: 12px;
  color: #999;
  text-decoration: underline;
  cursor: pointer;
  padding: 2px 4px;
}
.quick-edit-btn:hover {
  color: #666;
}

.layout {
  display: grid;
  grid-template-columns: minmax(0, 35%) minmax(0, 65%);
  gap: 20px;
}
@media (max-width: 900px) {
  .layout { grid-template-columns: 1fr; }
}

.panel {
  background: var(--card-bg);
  border-radius: var(--border-radius);
  padding: 18px;
  box-shadow: 0 10px 26px rgba(0,0,0,0.06);
  min-height: 320px;
}

.panel-title {
  font-size: 16px;
  font-weight: 600;
  margin-bottom: 12px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  color: #555;
  gap: 10px;
}

.tag {
  display: inline-block;
  padding: 4px 12px;
  border-radius: 999px;
  font-size: 12px;
  background: #f2f3f7;
  color: #777;
}

.btn {
  border: none;
  border-radius: 999px;
  padding: 8px 16px;
  font-size: 14px;
  cursor: pointer;
  font-family: inherit;
  display: inline-flex;
  align-items: center;
  gap: 4px;
}
.btn-primary { background: --primary; background: var(--primary); color: #fff; }
.btn-secondary { background: #f2f3f7; color: #555; }
.btn-mini { padding: 6px 13px; font-size: 13px; }
.btn-danger { background: #ffe5e5; color: #b43737; }

select.sort-select {
  border-radius: 999px;
  border: 1px solid #e0e2ea;
  padding: 5px 10px;
  font-size: 13px;
  background: #f9fafc;
}

/* é¡åˆ¥åˆ—è¡¨ */
#categoryList { max-height: 520px; overflow-y: auto; }

.category-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 12px 14px;
  margin-bottom: 10px;
  border-radius: 14px;
  cursor: pointer;
  background: #fafbff;
  border: 1px solid transparent;
  transition: all 0.15s ease;
}
.category-item:hover {
  background: #fff7ef;
  border-color: var(--primary-soft);
  transform: translateY(-1px);
}
.category-item.active {
  background: #ffefe0;
  border-color: var(--primary);
}
.category-name {
  font-size: 15px;
  font-weight: 600;
  color: #444;
}
.category-count {
  font-size: 12px;
  color: #777;
  background: #f2f3f7;
  border-radius: 999px;
  padding: 4px 10px;
}

.category-order-btn {
  margin-top: 4px;
  border: none;
  border-radius: 999px;
  padding: 3px 10px;
  font-size: 12px;
  background: #f2f3f7;
  color: #666;
  cursor: pointer;
}
.category-order-btn:hover {
  background: #ffe0c7;
  color: #b25a12;
}

/* è©±è¡“åˆ—è¡¨ */
#phraseList { max-height: 520px; overflow-y: auto; }

.phrase-row {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  gap: 12px;
  padding: 14px 14px;
  margin-bottom: 12px;
  border-radius: 14px;
  background: #fafbff;
  border: 1px solid #eceffd;
}

.phrase-text {
  font-size: 15px;
  color: #444;
  white-space: pre-wrap;
  word-break: break-word;
  line-height: 1.6;
}

.phrase-meta {
  font-size: 12px;
  color: #999;
  margin-bottom: 6px;
}

.phrase-note {
  font-size: 12px;
  color: #b26016;
  margin-top: 4px;
  line-height: 1.5;
  white-space: pre-wrap;
  word-break: break-word;
}

.phrase-actions {
  display: flex;
  flex-direction: column;
  gap: 6px;
  flex-shrink: 0;
}

.empty-text {
  font-size: 14px;
  color: #999;
  text-align: center;
  padding: 24px 8px;
}

#phraseSearch {
  width: 100%;
  padding: 9px 13px;
  border-radius: 999px;
  border: 1px solid #e0e2ea;
  font-size: 14px;
  margin-bottom: 12px;
  outline: none;
}
#phraseSearch:focus {
  border-color: var(--primary);
  box-shadow: 0 0 0 2px rgba(255,122,26,0.15);
}

.hint {
  font-size: 12px;
  color: #999;
  margin-top: 6px;
}

/* Modal */
.modal {
  position: fixed;
  inset: 0;
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 1000;
}
.modal.show { display: flex; }

.modal-backdrop {
  position: absolute;
  inset: 0;
  background: rgba(0,0,0,0.3);
}

.modal-content {
  position: relative;
  background: #fff;
  border-radius: 20px;
  padding: 22px 22px 18px;
  max-width: 620px;
  width: 96%;
  box-shadow: 0 20px 50px rgba(0,0,0,0.3);
  z-index: 1001;
}

.modal-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 14px;
}

.modal-header h2 {
  margin: 0;
  font-size: 18px;
}

.field { margin-bottom: 12px; }

.field label {
  font-size: 14px;
  display: block;
  margin-bottom: 5px;
  color: #555;
}

.field input,
.field textarea,
.field select {
  width: 100%;
  border-radius: 10px;
  border: 1px solid #e0e2ea;
  padding: 9px 10px;
  font-size: 14px;
  font-family: inherit;
  resize: vertical;
  min-height: 40px;
  outline: none;
}

.field textarea { min-height: 90px; }

.field input:focus,
.field textarea:focus,
.field select:focus {
  border-color: var(--primary);
  box-shadow: 0 0 0 2px rgba(255,122,26,0.15);
}

.modal-footer {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-top: 10px;
  gap: 10px;
  flex-wrap: wrap;
}

.pill {
  display: inline-block;
  padding: 4px 10px;
  border-radius: 999px;
  background: #f7f1ff;
  color: #7b4bb8;
  font-size: 12px;
}

/* å¿«æ·éµç·¨è¼¯åˆ— */
.shortcut-row {
  display: flex;
  gap: 6px;
  margin-bottom: 6px;
}
.shortcut-row input {
  flex: 1;
}
.shortcut-delete-btn {
  border: none;
  border-radius: 8px;
  background: #ffe5e5;
  color: #b43737;
  font-size: 12px;
  padding: 4px 8px;
  cursor: pointer;
}
.shortcut-delete-btn:hover {
  background: #ffcccc;
}

/* Toast */
#toast {
  position: fixed;
  right: 24px;
  bottom: 24px;
  background: #2e7d32;
  color: #fff;
  padding: 10px 16px;
  border-radius: 999px;
  font-size: 13px;
  display: flex;
  align-items: center;
  gap: 6px;
  box-shadow: 0 10px 28px rgba(0,0,0,0.28);
  opacity: 0;
  transform: translateY(10px);
  pointer-events: none;
  transition: opacity 0.18s ease, transform 0.18s ease;
  z-index: 2000;
}
#toast.show {
  opacity: 1;
  transform: translateY(0);
}
#toast.error { background: #c62828; }

</style>
</head>
<body>

<div class="app">
  <header>
    <div class="title-block">
      <h1>Ekkorn è©±è¡“å·¥å…· 2.3</h1>
      <p>é¡åˆ¥ç®¡ç†ãƒ»è‡ªè¨‚æ’åºãƒ»å…¨åŸŸå¿«æ·æœå°‹ãƒ»ä¸€éµè¤‡è£½</p>
    </div>
  </header>

  <!-- å…¨åŸŸæœå°‹ -->
  <input id="globalSearch" type="text" placeholder="ğŸ” åœ¨æ‰€æœ‰è©±è¡“ä¸­æœå°‹ï¼ˆé¡åˆ¥ / å…§å®¹ / å‚™è¨»ï¼‰â€¦">
  <div id="quickSearchContainer" class="quick-container"></div>

  <div class="layout">
    <!-- å·¦ï¼šé¡åˆ¥åˆ—è¡¨ -->
    <section class="panel">
      <div class="panel-title">
        <span>é¡åˆ¥</span>
        <span class="tag" id="totalCountTag">0 ç­†è©±è¡“</span>
      </div>
      <div id="categoryList"></div>
      <div class="hint">æç¤ºï¼šé»é¡åˆ¥ä¸‹é¢çš„ã€Œåºã€æŒ‰éˆ•å³å¯å¿«é€Ÿèª¿æ•´æ’åºã€‚</div>
    </section>

    <!-- å³ï¼šè©±è¡“åˆ—è¡¨æˆ–æœå°‹çµæœ -->
    <section class="panel">
      <div class="panel-title">
        <span id="currentCategoryLabel">è«‹å…ˆé¸æ“‡å·¦å´é¡åˆ¥ï¼Œæˆ–ç›´æ¥ä½¿ç”¨ä¸Šæ–¹å…¨åŸŸæœå°‹</span>
        <button class="btn btn-primary" onclick="openAddModal()">ï¼‹ æ–°å¢è©±è¡“</button>
      </div>
      <input id="phraseSearch" type="text" placeholder="åœ¨ç›®å‰é¡åˆ¥ä¸­æœå°‹é—œéµå­—ï¼ˆå…§å®¹ / å‚™è¨»ï¼‰â€¦" />
      <div id="phraseList"></div>
    </section>
  </div>
</div>

<!-- æ–°å¢ / ç·¨è¼¯ è©±è¡“ Modal -->
<div id="phraseModal" class="modal">
  <div class="modal-backdrop" onclick="closeModal()"></div>
  <div class="modal-content">
    <div class="modal-header">
      <h2 id="modalTitle">æ–°å¢è©±è¡“</h2>
      <span id="modalModePill" class="pill">æ–°å¢æ¨¡å¼</span>
    </div>

    <input type="hidden" id="modalId">

    <div class="field">
      <label>é¡åˆ¥</label>
      <select id="modalCategorySelect"></select>
      <div class="hint">å¯å¾æ—¢æœ‰é¡åˆ¥é¸æ“‡ï¼Œæˆ–åœ¨ä¸‹æ–¹è¼¸å…¥æ–°é¡åˆ¥ã€‚</div>
    </div>

    <div class="field">
      <label>æ–°å¢é¡åˆ¥ï¼ˆé¸å¡«ï¼Œè‹¥å¡«å¯«å°‡è¦†è“‹ä¸Šæ–¹é¸æ“‡ï¼‰</label>
      <input id="modalCategoryNew" placeholder="ä¾‹å¦‚ï¼šè¿è³“èªã€å®‰æ’«ã€é“æ­‰ã€æ´»å‹•èªªæ˜â€¦" />
    </div>

    <div class="field">
      <label>é¡åˆ¥æ’åºæ•¸å­—ï¼ˆé¸å¡«ï¼Œæ•¸å­—è¶Šå°è¶Šå‰é¢ï¼›ä¾‹å¦‚ 1, 2, 3â€¦ï¼‰</label>
      <input id="modalCatOrder" type="number" min="0" step="1" placeholder="ä¾‹å¦‚ï¼š1">
    </div>

    <div class="field">
      <label>å…§å®¹ï¼ˆå¯¦éš›è²¼çµ¦ç”¨æˆ¶çš„è©±è¡“ï¼‰</label>
      <textarea id="modalContent" placeholder="æ‚¨å¥½ï½æ­¡è¿ä¾†åˆ° Ekkornï¼Œæˆ‘æ˜¯å®¢æœï¼Œæœ‰ä»€éº¼åœ°æ–¹å¯ä»¥å”åŠ©æ‚¨çš„å—ï¼Ÿ"></textarea>
    </div>

    <div class="field">
      <label>å°è©±ç¤ºä¾‹ï¼ˆå¯é¸å¡«ï¼Œç”¨ä¾†èªªæ˜æƒ…å¢ƒï¼‰</label>
      <textarea id="modalExample" placeholder="å®¢ï¼šâ€¦&#10;æœï¼šâ€¦"></textarea>
    </div>

    <div class="field">
      <label>æ­¤è©±è¡“æ’åºæ•¸å­—ï¼ˆé¸å¡«ï¼ŒåŒä¸€é¡åˆ¥å…§ï¼Œæ•¸å­—è¶Šå°è¶Šä¸Šé¢ï¼‰</label>
      <input id="modalPhraseOrder" type="number" min="0" step="1" placeholder="ä¾‹å¦‚ï¼š1">
    </div>

    <div class="field">
      <label>å‚™è¨»ï¼ˆä½¿ç”¨æé†’ã€é©åˆï¼ä¸é©åˆçš„æƒ…å¢ƒç­‰ï¼‰</label>
      <textarea id="modalNote" placeholder="ä¾‹å¦‚ï¼šä¸é©ç”¨æ–¼å·²æ˜é¡¯æƒ…ç·’æ€§æŠ±æ€¨çš„æƒ…æ³â€¦"></textarea>
    </div>

    <div class="modal-footer">
      <div>
        <button class="btn btn-primary" onclick="saveFromModal()">ğŸ’¾ å„²å­˜</button>
        <button class="btn btn-secondary" onclick="closeModal()">å–æ¶ˆ</button>
      </div>
      <button class="btn btn-danger" id="modalDeleteBtn" style="display:none;" onclick="deleteFromModal()">ğŸ—‘ åˆªé™¤</button>
    </div>
  </div>
</div>

<!-- é¡åˆ¥æ’åº Modal -->
<div id="categoryOrderModal" class="modal">
  <div class="modal-backdrop" onclick="closeCategoryOrderModal()"></div>
  <div class="modal-content">
    <div class="modal-header">
      <h2>èª¿æ•´é¡åˆ¥æ’åº</h2>
    </div>
    <div class="field">
      <label>é¡åˆ¥åç¨±</label>
      <div id="catOrderCategoryName" style="font-size:14px;font-weight:600;"></div>
    </div>
    <div class="field">
      <label>æ’åºæ•¸å­—ï¼ˆæ•¸å­—è¶Šå°è¶Šå‰é¢ï¼‰</label>
      <input id="catOrderInput" type="number" min="0" step="1">
    </div>
    <div class="modal-footer">
      <div>
       <button class="btn btn-primary" id="catOrderSaveBtn" onclick="saveCategoryOrder()">å„²å­˜</button>
       <button class="btn btn-secondary" onclick="closeCategoryOrderModal()">å–æ¶ˆ</button>
      </div>
       <span id="catOrderStatus" class="hint" style="display:none;">æ­£åœ¨æ›´æ–°é¡åˆ¥æ’åºï¼Œè«‹ç¨å€™â€¦</span>
    </div>
  </div>
</div>

<!-- å¿«é€Ÿæœå°‹å¿«æ·éµ Modal -->
<div id="shortcutModal" class="modal">
  <div class="modal-backdrop" onclick="closeShortcutModal()"></div>
  <div class="modal-content">
    <div class="modal-header">
      <h2>ç·¨è¼¯å¿«é€Ÿæœå°‹éµ</h2>
    </div>
    <div class="field">
      <label>æœ€å¤šå¯è¨­å®š 15 å€‹å¸¸ç”¨é—œéµå­—</label>
      <div id="shortcutList"></div>
      <button class="btn btn-secondary btn-mini" id="addShortcutBtn" type="button" onclick="addShortcutRow()">ï¼‹ æ–°å¢å¿«æ·éµ</button>
      <div class="hint">æç¤ºï¼šæŒ‰å„²å­˜å¾Œï¼Œæœƒé¡¯ç¤ºåœ¨å…¨åŸŸæœå°‹æ¬„ä½ä¸‹æ–¹çš„å°æŒ‰éˆ•ã€‚</div>
    </div>
    <div class="modal-footer">
      <div>
        <button class="btn btn-primary" onclick="saveShortcuts()">å„²å­˜</button>
        <button class="btn btn-secondary" onclick="closeShortcutModal()">å–æ¶ˆ</button>
      </div>
    </div>
  </div>
</div>

<!-- Toast -->
<div id="toast">
  <span id="toastIcon">âœ”</span>
  <span id="toastText">å·²è¤‡è£½</span>
</div>

<script>
const API = "https://script.google.com/macros/s/AKfycbztZuAh2G_c5Dy3nGvjnV5TdKyJ6FEHMpVpcYHEUT3eT_50BMULOaFTWX1IRL_eSR81/exec";
const SHORTCUTS_KEY = "ekkornQuickSearchShortcuts";

let fullData = [];
let categories = [];
let currentCategory = null;
let modalMode = "add";
let editingItem = null;
let toastTimer = null;
let deleteArmed = false; // åˆªé™¤äºŒæ®µå¼ç¢ºèªç”¨
let editingCategory = null; // é¡åˆ¥æ’åºç·¨è¼¯ä¸­
let quickShortcuts = [];

// å·¥å…·ï¼šé¡¯ç¤º Toast
function showToast(message, isError = false) {
  const toast = document.getElementById("toast");
  const text = document.getElementById("toastText");
  const icon = document.getElementById("toastIcon");
  text.textContent = message;
  icon.textContent = isError ? "âœ•" : "âœ”";
  toast.classList.remove("error");
  if (isError) toast.classList.add("error");
  toast.classList.add("show");
  if (toastTimer) clearTimeout(toastTimer);
  toastTimer = setTimeout(() => toast.classList.remove("show"), 1800);
}

// è®€å– / å„²å­˜ å¿«æ·éµ
function loadShortcutsFromStorage() {
  try {
    const raw = localStorage.getItem(SHORTCUTS_KEY);
    quickShortcuts = raw ? JSON.parse(raw) : [];
    if (!Array.isArray(quickShortcuts)) quickShortcuts = [];
  } catch (e) {
    quickShortcuts = [];
  }
}

function saveShortcutsToStorage() {
  try {
    localStorage.setItem(SHORTCUTS_KEY, JSON.stringify(quickShortcuts));
  } catch (e) {
    console.error(e);
  }
}

function renderShortcutChips() {
  const container = document.getElementById("quickSearchContainer");
  if (!container) return;
  container.innerHTML = "";

  const labelSpan = document.createElement("span");
  labelSpan.className = "quick-label";
  labelSpan.textContent = "å¿«é€Ÿæœå°‹ï¼š";
  container.appendChild(labelSpan);

  quickShortcuts.forEach(word => {
    const btn = document.createElement("button");
    btn.type = "button";
    btn.className = "quick-chip";
    btn.textContent = word;
    btn.addEventListener("click", () => {
      document.getElementById("globalSearch").value = word;
      document.getElementById("phraseSearch").value = "";
      renderPhrases();
    });
    container.appendChild(btn);
  });

  const editBtn = document.createElement("button");
  editBtn.type = "button";
  editBtn.className = "quick-edit-btn";
  editBtn.textContent = "âœ ç·¨è¼¯å¿«æ·éµ";
  editBtn.addEventListener("click", openShortcutModal);
  container.appendChild(editBtn);

  if (quickShortcuts.length === 0) {
    const emptyHint = document.createElement("span");
    emptyHint.className = "hint";
    emptyHint.textContent = "ï¼ˆç›®å‰å°šæœªè¨­å®šï¼Œé»å³å´ç·¨è¼¯æ–°å¢ï¼‰";
    container.appendChild(emptyHint);
  }
}

// è¼‰å…¥è³‡æ–™
async function loadData() {
  try {
    const res = await fetch(API + "?action=list");
    fullData = await res.json();
    rebuildCategories();
    renderCategories();
    renderPhrases();
    updateTotalCount();
  } catch (err) {
    console.error(err);
    alert("è¼‰å…¥è³‡æ–™æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹æª¢æŸ¥ API é€£çµæˆ– Apps Script éƒ¨ç½²è¨­å®šã€‚");
  }
}

function updateTotalCount() {
  const total = fullData.length || 0;
  document.getElementById("totalCountTag").textContent = `${total} ç­†è©±è¡“`;
}

// é‡å»ºé¡åˆ¥
function rebuildCategories() {
  const set = new Set();
  fullData.forEach(item => {
    const cat = (item.category || "æœªåˆ†é¡").trim();
    if (cat) set.add(cat);
  });
  categories = Array.from(set);
  if (!currentCategory && categories.length > 0) currentCategory = categories[0];
}

// é¡åˆ¥æ’åºå€¼ï¼šè©²é¡åˆ¥æ‰€æœ‰è©±è¡“çš„ cat_order ä¸­æœ€å°å€¼
function getCategoryOrder(cat) {
  const items = fullData.filter(i => (i.category || "æœªåˆ†é¡").trim() === cat);
  const nums = items
    .map(i => parseFloat(i.cat_order))
    .filter(n => !isNaN(n));
  return nums.length ? Math.min(...nums) : Number.POSITIVE_INFINITY;
}

// é¡åˆ¥åˆ—è¡¨æ¸²æŸ“
function renderCategories() {
  const list = document.getElementById("categoryList");
  list.innerHTML = "";

  if (!categories.length) {
    list.innerHTML = `<div class="empty-text">ç›®å‰å°šç„¡ä»»ä½•è©±è¡“ï¼Œè«‹å…ˆé»å³å´ã€Œï¼‹ æ–°å¢è©±è¡“ã€ã€‚</div>`;
    currentCategory = null;
    document.getElementById("currentCategoryLabel").textContent =
      "è«‹å…ˆé¸æ“‡å·¦å´é¡åˆ¥ï¼Œæˆ–ç›´æ¥ä½¿ç”¨ä¸Šæ–¹å…¨åŸŸæœå°‹";
    return;
  }

  let cats = [...categories];
  cats.sort((a, b) => {
    const oa = getCategoryOrder(a);
    const ob = getCategoryOrder(b);
    if (oa === ob) return a.localeCompare(b, "zh-Hant");
    return oa - ob;
  });

  cats.forEach(cat => {
    const div = document.createElement("div");
    div.className = "category-item" + (cat === currentCategory ? " active" : "");
    const count = fullData.filter(item => (item.category || "æœªåˆ†é¡").trim() === cat).length;

    const order = getCategoryOrder(cat);
    const orderText = isFinite(order) ? `åºï¼š${order}` : "åºï¼šâ€”";

    const left = document.createElement("div");
    const nameDiv = document.createElement("div");
    nameDiv.className = "category-name";
    nameDiv.textContent = cat;

    const orderBtn = document.createElement("button");
    orderBtn.type = "button";
    orderBtn.className = "category-order-btn";
    orderBtn.textContent = orderText;
    orderBtn.addEventListener("click", (e) => {
      e.stopPropagation();
      openCategoryOrderModal(cat);
    });

    left.appendChild(nameDiv);
    left.appendChild(orderBtn);

    const countDiv = document.createElement("div");
    countDiv.className = "category-count";
    countDiv.textContent = count;

    div.appendChild(left);
    div.appendChild(countDiv);

    div.addEventListener("click", () => {
      currentCategory = cat;
      document.getElementById("phraseSearch").value = "";
      document.getElementById("globalSearch").value = "";
      renderCategories();
      renderPhrases();
    });

    list.appendChild(div);
  });

  document.getElementById("currentCategoryLabel").textContent =
    currentCategory ? `é¡åˆ¥ï¼š${currentCategory}` : "è«‹å…ˆé¸æ“‡å·¦å´é¡åˆ¥ï¼Œæˆ–ç›´æ¥ä½¿ç”¨ä¸Šæ–¹å…¨åŸŸæœå°‹";
}

// è©±è¡“æ’åºå€¼
function getPhraseOrder(item) {
  const n = parseFloat(item.phrase_order);
  return isNaN(n) ? Number.POSITIVE_INFINITY : n;
}

// æ¸²æŸ“è©±è¡“ï¼ˆå«å…¨åŸŸæœå°‹æ¨¡å¼ï¼‰
function renderPhrases() {
  const list = document.getElementById("phraseList");
  list.innerHTML = "";

  const globalKey = document.getElementById("globalSearch").value.trim().toLowerCase();

  // å…¨åŸŸæœå°‹æ¨¡å¼
  if (globalKey) {
    const matched = fullData.filter(item => {
      const cat = (item.category || "").toLowerCase();
      const content = (item.content || "").toLowerCase();
      const note = (item.note || "").toLowerCase();
      return cat.includes(globalKey) || content.includes(globalKey) || note.includes(globalKey);
    });

    document.getElementById("currentCategoryLabel").textContent =
      `å…¨åŸŸæœå°‹ï¼šã€Œ${globalKey}ã€ï¼ ${matched.length} ç­†çµæœ`;

    if (!matched.length) {
      list.innerHTML = `<div class="empty-text">æ²’æœ‰ç¬¦åˆçš„è©±è¡“ã€‚</div>`;
      return;
    }

    matched.sort((a, b) => {
      const ca = (a.category || "").localeCompare((b.category || ""), "zh-Hant");
      if (ca !== 0) return ca;
      return getPhraseOrder(a) - getPhraseOrder(b);
    });

    matched.forEach(item => {
      const row = document.createElement("div");
      row.className = "phrase-row";

      const textDiv = document.createElement("div");
      textDiv.className = "phrase-text";

      const catName = item.category || "æœªåˆ†é¡";
      const meta = document.createElement("div");
      meta.className = "phrase-meta";
      meta.textContent = `é¡åˆ¥ï¼š${catName}`;
      const content = document.createElement("div");
      content.textContent = item.content || "ï¼ˆç„¡å…§å®¹ï¼‰";

      textDiv.appendChild(meta);
      textDiv.appendChild(content);

      if (item.note) {
        const noteDiv = document.createElement("div");
        noteDiv.className = "phrase-note";
        noteDiv.textContent = `å‚™è¨»ï¼š${item.note}`;
        textDiv.appendChild(noteDiv);
      }

      const actionsDiv = document.createElement("div");
      actionsDiv.className = "phrase-actions";

      const copyBtn = document.createElement("button");
      copyBtn.className = "btn btn-secondary btn-mini";
      copyBtn.textContent = "è¤‡è£½";
      copyBtn.addEventListener("click", (e) => {
        e.stopPropagation();
        copyText(item.content || "");
      });

      const detailBtn = document.createElement("button");
      detailBtn.className = "btn btn-secondary btn-mini";
      detailBtn.textContent = "è©³æƒ…";
      detailBtn.addEventListener("click", (e) => {
        e.stopPropagation();
        openEditModal(item);
      });

      actionsDiv.appendChild(copyBtn);
      actionsDiv.appendChild(detailBtn);

      row.appendChild(textDiv);
      row.appendChild(actionsDiv);

      list.appendChild(row);
    });

    return;
  }

  // é¡åˆ¥æ¨¡å¼
  if (!currentCategory) {
    list.innerHTML = `<div class="empty-text">å·¦å´é¸ä¸€å€‹é¡åˆ¥ï¼Œæˆ–å…ˆæ–°å¢ä¸€ç­†è©±è¡“å»ºç«‹æ–°é¡åˆ¥ã€‚</div>`;
    return;
  }

  const keyword = document.getElementById("phraseSearch").value.trim().toLowerCase();

  let filtered = fullData.filter(item => {
    const cat = (item.category || "æœªåˆ†é¡").trim();
    if (cat !== currentCategory) return false;
    if (!keyword) return true;
    const content = (item.content || "").toLowerCase();
    const note = (item.note || "").toLowerCase();
    return content.includes(keyword) || note.includes(keyword);
  });

  filtered.sort((a, b) => {
    const oa = getPhraseOrder(a);
    const ob = getPhraseOrder(b);
    if (oa === ob) {
      const da = new Date(a.updated_at || 0);
      const db = new Date(b.updated_at || 0);
      return db - da;
    }
    return oa - ob;
  });

  if (!filtered.length) {
    list.innerHTML = `<div class="empty-text">æ­¤é¡åˆ¥ç›®å‰æ²’æœ‰ç¬¦åˆé—œéµå­—çš„è©±è¡“ã€‚</div>`;
    return;
  }

  filtered.forEach(item => {
    const row = document.createElement("div");
    row.className = "phrase-row";

    const textDiv = document.createElement("div");
    textDiv.className = "phrase-text";

    const content = document.createElement("div");
    content.textContent = item.content || "ï¼ˆç„¡å…§å®¹ï¼‰";

    textDiv.appendChild(content);

    if (item.note) {
      const noteDiv = document.createElement("div");
      noteDiv.className = "phrase-note";
      noteDiv.textContent = `å‚™è¨»ï¼š${item.note}`;
      textDiv.appendChild(noteDiv);
    }

    const actionsDiv = document.createElement("div");
    actionsDiv.className = "phrase-actions";

    const copyBtn = document.createElement("button");
    copyBtn.className = "btn btn-secondary btn-mini";
    copyBtn.textContent = "è¤‡è£½";
    copyBtn.addEventListener("click", (e) => {
      e.stopPropagation();
      copyText(item.content || "");
    });

    const detailBtn = document.createElement("button");
    detailBtn.className = "btn btn-secondary btn-mini";
    detailBtn.textContent = "è©³æƒ…";
    detailBtn.addEventListener("click", (e) => {
      e.stopPropagation();
      openEditModal(item);
    });

    actionsDiv.appendChild(copyBtn);
    actionsDiv.appendChild(detailBtn);

    row.appendChild(textDiv);
    row.appendChild(actionsDiv);

    list.appendChild(row);
  });
}

// è¤‡è£½ï¼ˆç”¨ Toastï¼Œå« iframe fallbackï¼‰
function copyText(text) {
  if (!text) {
    showToast("æ²’æœ‰å¯è¤‡è£½çš„å…§å®¹", true);
    return;
  }

  if (navigator.clipboard && navigator.clipboard.writeText) {
    navigator.clipboard.writeText(text)
      .then(() => showToast("å·²è¤‡è£½è©±è¡“å…§å®¹"))
      .catch(() => fallbackCopy(text));
  } else {
    fallbackCopy(text);
  }
}

// å‚™ç”¨è¤‡è£½ï¼šå»ºç«‹éš±è— textarea + execCommand("copy")
function fallbackCopy(text) {
  try {
    const textarea = document.createElement("textarea");
    textarea.value = text;
    textarea.style.position = "fixed";
    textarea.style.left = "-9999px";
    textarea.style.top = "0";
    document.body.appendChild(textarea);
    textarea.focus();
    textarea.select();

    const ok = document.execCommand("copy");
    document.body.removeChild(textarea);

    if (ok) {
      showToast("å·²è¤‡è£½è©±è¡“å…§å®¹");
    } else {
      throw new Error("execCommand copy failed");
    }
  } catch (err) {
    console.error(err);
    showToast("è¤‡è£½å¤±æ•—ï¼Œè«‹æ‰‹å‹•é¸å–æ–‡å­—å¾ŒæŒ‰ Ctrl+C / âŒ˜+C", true);
  }
}

// é–‹å•Ÿæ–°å¢ Modal
function openAddModal() {
  modalMode = "add";
  editingItem = null;

  document.getElementById("modalTitle").textContent = "æ–°å¢è©±è¡“";
  document.getElementById("modalModePill").textContent = "æ–°å¢æ¨¡å¼";
  document.getElementById("modalDeleteBtn").style.display = "none";

  document.getElementById("modalId").value = "";
  fillCategorySelect();
  document.getElementById("modalCategoryNew").value = "";
  document.getElementById("modalContent").value = "";
  document.getElementById("modalExample").value = "";
  document.getElementById("modalNote").value = "";
  document.getElementById("modalCatOrder").value = suggestCategoryOrder();
  document.getElementById("modalPhraseOrder").value = suggestPhraseOrder();

  document.getElementById("phraseModal").classList.add("show");
}

// é–‹å•Ÿç·¨è¼¯ Modal
function openEditModal(item) {
  modalMode = "edit";
  editingItem = item || null;

  document.getElementById("modalTitle").textContent = "ç·¨è¼¯è©±è¡“";
  document.getElementById("modalModePill").textContent = "ç·¨è¼¯æ¨¡å¼";
  document.getElementById("modalDeleteBtn").style.display = "inline-flex";

  document.getElementById("modalId").value = item.id || "";
  fillCategorySelect(item.category || "");
  document.getElementById("modalCategoryNew").value = "";
  document.getElementById("modalContent").value = item.content || "";
  document.getElementById("modalExample").value = item.example || "";
  document.getElementById("modalNote").value = item.note || "";
  document.getElementById("modalCatOrder").value =
    item.cat_order !== undefined && item.cat_order !== null ? item.cat_order : "";
  document.getElementById("modalPhraseOrder").value =
    item.phrase_order !== undefined && item.phrase_order !== null ? item.phrase_order : "";

  document.getElementById("phraseModal").classList.add("show");
}

// å»ºè­°é¡åˆ¥æ’åºæ•¸å­—
function suggestCategoryOrder() {
  if (currentCategory) {
    const order = getCategoryOrder(currentCategory);
    if (isFinite(order)) return order;
  }
  const orders = categories
    .map(c => getCategoryOrder(c))
    .filter(n => isFinite(n));
  if (!orders.length) return "";
  return Math.max(...orders) + 1;
}

// å»ºè­°è©±è¡“æ’åºæ•¸å­—ï¼ˆç›®å‰é¡åˆ¥å…§æœ€å¤§ +1ï¼‰
function suggestPhraseOrder() {
  if (!currentCategory) return "";
  const list = fullData.filter(i => (i.category || "æœªåˆ†é¡").trim() === currentCategory);
  const orders = list
    .map(i => parseFloat(i.phrase_order))
    .filter(n => !isNaN(n));
  if (!orders.length) return "";
  return Math.max(...orders) + 1;
}

// é¡åˆ¥ä¸‹æ‹‰é¸å–®
function fillCategorySelect(selected) {
  const sel = document.getElementById("modalCategorySelect");
  sel.innerHTML = "";

  const placeholder = document.createElement("option");
  placeholder.value = "";
  placeholder.textContent = "ï¼ˆè«‹é¸æ“‡é¡åˆ¥ï¼Œæˆ–ä¸‹æ–¹è¼¸å…¥æ–°é¡åˆ¥ï¼‰";
  sel.appendChild(placeholder);

  let cats = [...categories];
  cats.sort((a, b) => {
    const oa = getCategoryOrder(a);
    const ob = getCategoryOrder(b);
    if (oa === ob) return a.localeCompare(b, "zh-Hant");
    return oa - ob;
  });

  cats.forEach(cat => {
    const opt = document.createElement("option");
    opt.value = cat;
    opt.textContent = cat;
    if (selected && selected === cat) opt.selected = true;
    if (!selected && currentCategory && currentCategory === cat) opt.selected = true;
    sel.appendChild(opt);
  });
}

// é—œé–‰è©±è¡“ Modal
function closeModal() {
  document.getElementById("phraseModal").classList.remove("show");
  editingItem = null;
}

// å­˜æª”
async function saveFromModal() {
  const id = document.getElementById("modalId").value.trim();
  const categorySelect = document.getElementById("modalCategorySelect").value.trim();
  const categoryNew = document.getElementById("modalCategoryNew").value.trim();
  const content = document.getElementById("modalContent").value.trim();
  const example = document.getElementById("modalExample").value.trim();
  const note = document.getElementById("modalNote").value.trim();
  let catOrder = document.getElementById("modalCatOrder").value.trim();
  let phraseOrder = document.getElementById("modalPhraseOrder").value.trim();

  if (!content) {
    alert("è‡³å°‘éœ€è¦å¡«å¯«ã€å…§å®¹ã€æ¬„ä½å”·ï½");
    return;
  }

  const finalCategory = categoryNew || categorySelect || "æœªåˆ†é¡";

  if (!catOrder) {
    const orders = categories
      .map(c => getCategoryOrder(c))
      .filter(n => isFinite(n));
    catOrder = orders.length ? (Math.max(...orders) + 1).toString() : "1";
  }

  if (!phraseOrder) {
    const list = fullData.filter(i => (i.category || "æœªåˆ†é¡").trim() === finalCategory);
    const orders = list
      .map(i => parseFloat(i.phrase_order))
      .filter(n => !isNaN(n));
    phraseOrder = orders.length ? (Math.max(...orders) + 1).toString() : "1";
  }

  const action = id ? "update" : "add";

  const params = new URLSearchParams({
    action,
    id,
    category: finalCategory,
    cat_order: catOrder,
    content,
    example,
    note,
    phrase_order: phraseOrder
  });

  try {
    await fetch(`${API}?${params.toString()}`);
    alert("å·²å„²å­˜ï¼");
    closeModal();
    await loadData();
    currentCategory = finalCategory;
    renderCategories();
    renderPhrases();
  } catch (err) {
    console.error(err);
    alert("å„²å­˜å¤±æ•—ï¼Œè«‹æª¢æŸ¥ API é€£çµæˆ– Apps Script éƒ¨ç½²ã€‚");
  }
}

// åˆªé™¤ï¼ˆé›™æ“Šç¢ºèªï¼Œé¿å… iframe è¢« confirm æ“‹æ‰ï¼‰
async function deleteFromModal() {
  const id = document.getElementById("modalId").value.trim();
  if (!id) return;

  const btn = document.getElementById("modalDeleteBtn");

  if (!deleteArmed) {
    deleteArmed = true;
    const originalText = btn.textContent;
    btn.dataset.originalText = originalText;
    btn.textContent = "âš  å†æ¬¡é»æ“Šç¢ºèªåˆªé™¤";
    btn.style.background = "#ffb3b3";

    setTimeout(() => {
      if (deleteArmed) {
        deleteArmed = false;
        btn.textContent = btn.dataset.originalText || "ğŸ—‘ åˆªé™¤";
        btn.style.background = "";
      }
    }, 3000);

    return;
  }

  deleteArmed = false;
  btn.textContent = btn.dataset.originalText || "ğŸ—‘ åˆªé™¤";
  btn.style.background = "";

  const params = new URLSearchParams({
    action: "delete",
    id
  });

  try {
    await fetch(`${API}?${params.toString()}`);
    alert("å·²åˆªé™¤ã€‚");
    closeModal();
    await loadData();
    renderCategories();
    renderPhrases();
  } catch (err) {
    console.error(err);
    alert("åˆªé™¤å¤±æ•—ï¼Œè«‹æª¢æŸ¥ API æˆ– Apps Scriptã€‚");
  }
}

/* é¡åˆ¥æ’åº Modal æ§åˆ¶ */
function openCategoryOrderModal(cat) {
  editingCategory = cat;
  document.getElementById("catOrderCategoryName").textContent = cat;
  const order = getCategoryOrder(cat);
  document.getElementById("catOrderInput").value = isFinite(order) ? order : "";
  document.getElementById("categoryOrderModal").classList.add("show");
}

function closeCategoryOrderModal() {
  editingCategory = null;
  document.getElementById("categoryOrderModal").classList.remove("show");
}

async function saveCategoryOrder() {
  if (!editingCategory) {
    closeCategoryOrderModal();
    return;
  }

  const input = document.getElementById("catOrderInput");
  let value = input.value.trim();
  if (value === "") {
    alert("è«‹è¼¸å…¥æ’åºæ•¸å­—å”·ï½");
    return;
  }
  const num = parseFloat(value);
  if (!isFinite(num)) {
    alert("æ’åºå¿…é ˆæ˜¯æ•¸å­—ã€‚");
    return;
  }
  const newOrder = num.toString();

  const items = fullData.filter(item => (item.category || "æœªåˆ†é¡").trim() === editingCategory);

  const btn = document.getElementById("catOrderSaveBtn");
  const statusEl = document.getElementById("catOrderStatus");
  const originalText = btn.textContent;

  // ğŸ”¸ é¡¯ç¤ºã€Œå„²å­˜ä¸­ã€ç‹€æ…‹
  btn.disabled = true;
  btn.textContent = "å„²å­˜ä¸­â€¦";
  if (statusEl) {
    statusEl.style.display = "inline-block";
    statusEl.textContent = "æ­£åœ¨æ›´æ–°é¡åˆ¥æ’åºï¼Œè«‹ç¨å€™â€¦";
  }

  try {
    for (const item of items) {
      const params = new URLSearchParams({
        action: "update",
        id: item.id,
        category: item.category || "",
        cat_order: newOrder,
        content: item.content || "",
        example: item.example || "",
        note: item.note || "",
        phrase_order: item.phrase_order || ""
      });
      await fetch(`${API}?${params.toString()}`);
    }
    showToast("å·²æ›´æ–°é¡åˆ¥æ’åº");
    closeCategoryOrderModal();
    await loadData();
  } catch (err) {
    console.error(err);
    alert("æ›´æ–°é¡åˆ¥æ’åºå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚");
  } finally {
    // ğŸ”¸ é‚„åŸæŒ‰éˆ• & æç¤ºæ–‡å­—
    btn.disabled = false;
    btn.textContent = originalText;
    if (statusEl) {
      statusEl.style.display = "none";
    }
  }
}

/* å¿«æ·éµ Modal æ§åˆ¶ */
function openShortcutModal() {
  const listDiv = document.getElementById("shortcutList");
  listDiv.innerHTML = "";
  quickShortcuts.forEach(word => addShortcutRow(word));
  updateAddShortcutBtn();
  document.getElementById("shortcutModal").classList.add("show");
}

function closeShortcutModal() {
  document.getElementById("shortcutModal").classList.remove("show");
}

function addShortcutRow(initial = "") {
  const listDiv = document.getElementById("shortcutList");
  const row = document.createElement("div");
  row.className = "shortcut-row";

  const input = document.createElement("input");
  input.type = "text";
  input.maxLength = 50;
  input.value = initial;

  const delBtn = document.createElement("button");
  delBtn.type = "button";
  delBtn.className = "shortcut-delete-btn";
  delBtn.textContent = "åˆªé™¤";
  delBtn.addEventListener("click", () => {
    row.remove();
    updateAddShortcutBtn();
  });

  row.appendChild(input);
  row.appendChild(delBtn);
  listDiv.appendChild(row);

  updateAddShortcutBtn();
}

function updateAddShortcutBtn() {
  const btn = document.getElementById("addShortcutBtn");
  const listDiv = document.getElementById("shortcutList");
  const count = listDiv.querySelectorAll(".shortcut-row").length;
  btn.disabled = count >= 15;
}

function saveShortcuts() {
  const listDiv = document.getElementById("shortcutList");
  const inputs = Array.from(listDiv.querySelectorAll(".shortcut-row input"));
  const words = [];
  inputs.forEach(input => {
    const v = input.value.trim();
    if (v) words.push(v);
  });

  const unique = [];
  for (const w of words) {
    if (!unique.includes(w)) unique.push(w);
    if (unique.length >= 15) break;
  }

  quickShortcuts = unique;
  saveShortcutsToStorage();
  renderShortcutChips();
  closeShortcutModal();
  showToast("å·²æ›´æ–°å¿«é€Ÿæœå°‹éµ");
}

// æœå°‹äº‹ä»¶
document.getElementById("phraseSearch").addEventListener("input", () => {
  renderPhrases();
});
document.getElementById("globalSearch").addEventListener("input", () => {
  document.getElementById("phraseSearch").value = "";
  renderPhrases();
});

// Esc é—œé–‰ä»»ä¸€ Modal
document.addEventListener("keydown", (e) => {
  if (e.key === "Escape") {
    const phraseModal = document.getElementById("phraseModal");
    const catModal = document.getElementById("categoryOrderModal");
    const shortcutModal = document.getElementById("shortcutModal");
    if (phraseModal.classList.contains("show")) closeModal();
    if (catModal.classList.contains("show")) closeCategoryOrderModal();
    if (shortcutModal.classList.contains("show")) closeShortcutModal();
  }
});

// åˆå§‹åŒ–
loadShortcutsFromStorage();
renderShortcutChips();
loadData();
</script>

</body>
</html>
